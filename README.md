# Introduction

This is an API for file service operations for TDEI system. This API
supports file uploads of GTFS-Pathways, GTFS-Flex v2 and OpenSidewalks
data.

### File Service workflow

1. **Client**, makes the HTTP multipart call to the **Gateway API** for the specified file type.

``` 
Multipart request will contain two information, one file stream and other metadata information

{ file : octate-stream }
__________________________________
{
 metadata :
   {
      validFrom : XXXX,
      validTo : XXXX
      ....
    }
 }
``` 

2. Gateway service routes this request to File Service
3. On API request file service will perform below job
    1. Generate unique record id (unique id) for each job.
    2. Retrieve the file stream and saves to the cloud storage under the specified file container ( folder)
    3. Upon successful upload to the cloud storage, it keeps the reference of the uploaded file path
    4. Compose new queue message with requested metadata and file upload path and publish to file specific topic
    5. Finally return the generated record id back to Gateway service for further tracking of the request.

## System requirements

| Software | Version |
|----------|---------|
| Java     | 17      |
| Maven    | > 3     |
| Spring   | 2.7.4   |

## Development IDE tool preference

Eclipse (https://www.eclipse.org/downloads/)

Intellij (https://www.jetbrains.com/idea/download)

## Dependencies

Other third-party dependencies used in the project please browse the Maven pom.xml file for details of libraries and
versions used.

## Cloning the project

Clone the project from source controller

```aidl
$ git clone https://TDEI-UW@dev.azure.com/TDEI-UW/TDEI/_git/file-service
```

## Secrets

Application secrets are not included in the code repository. Below are the instruction for each environment

###### Local

Request for **developer-local-properties.yaml** file from Admin, which should be copied to below location

```src/main/resources/developer-local-properties.yaml```

###### DEV/PROD

Required properties will be set as an environment variables on the deployment environment.

        CLOUD_AZURE_STORAGE_BLOB_ACCOUNT_KEY
        CLOUD_AZURE_STORAGE_BLOB_CONNECTION_STRING
        CLOUD_AZURE_SERVICE_BUS_CONNECTION_STRING

## Building the project

### IDE

Import the project in your preferred IDE by selecting POM.xml.

### Cli

*Note: Navigate to the cloned repository directory before proceeding for below steps

### 1. Building the server

Use Maven command to build the server. Below mvn command will

1. Cleans the project and removes all files generated by the previous build
2. Builds the maven project and generates the jar package to target directory

```
$ mvn clean install
```

### 2. Running the server

```
$ cd target
$ java -jar -Dspring.profiles.active=dev filesvc-0.0.1.jar
```

### 3. Browse API documentation

Navigate to the below link for API documentation and API playground

http://localhost:8080/swagger-ui/index.html

## Running the test

- Uncomment the below line of code from Pom.xml.

  ```<maven.test.skip>true</maven.test.skip>```

- Run mvn command

```
$ mvn test
```

## CI/CD [Azure Pipeline]

### Continuous Integration (CI)

Currently, CI is not implemented as part of Azure pipeline. Test automated integration will be taken up in next
development cycle.

### Continuous Deployment (CD)

Check-in to the master branch triggers the Azure pipeline [gateway] CI/CD process which will build the source code,
generate the package and create the docker image. Docker image will then be deployed to Azure app services.

Process Flow Diagram:

![](src/main/resources/static/images/deployment-pipeline.png)

Development API documentation link

https://tdei-filesvc.azurewebsites.net/swagger-ui/index.html
